<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Cqrs-server : An opinionated CQRS/ES implementation using Onyx, Datomic, DynamoDB, Kafka and Zookeeper.">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Cqrs-server</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/Yuppiechef/cqrs-server">View on GitHub</a>

          <h1 id="project_title">Cqrs-server</h1>
          <h2 id="project_tagline">An opinionated CQRS/ES implementation using Onyx, Datomic, DynamoDB, Kafka and Zookeeper.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/Yuppiechef/cqrs-server/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/Yuppiechef/cqrs-server/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="cqrs-server" class="anchor" href="#cqrs-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>cqrs-server</h1>

<p>An opinionated CQRS/ES implementation using Onyx, Datomic, DynamoDB, Kafka and Zookeeper.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>A quick guide to get started :</p>

<h3>
<a id="install-dynamodb-local" class="anchor" href="#install-dynamodb-local" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install dynamodb local</h3>

<p>Get dynamodb local from: <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Tools.DynamoDBLocal.html">http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Tools.DynamoDBLocal.html</a></p>

<p>And then run:</p>

<pre><code>java -Djava.library.path=./DynamoDBLocal_lib -jar DynamoDBLocal.jar
</code></pre>

<h3>
<a id="kafka--zookeeper" class="anchor" href="#kafka--zookeeper" aria-hidden="true"><span class="octicon octicon-link"></span></a>Kafka &amp; Zookeeper</h3>

<p>Download and extract Kafka: <a href="http://kafka.apache.org/downloads.html">http://kafka.apache.org/downloads.html</a></p>

<p>Run both these (probably in separate terminals)</p>

<pre><code>bin/zookeeper-server-start.sh config/zookeeper.properties
bin/kafka-server-start.sh config/server.properties
</code></pre>

<p>Then clone this repo and fire it up!</p>

<pre><code>lein repl

=&gt; (start)
"Setup complete"
=&gt; (send-command :user/register {:name "Bob" :age 31})
nil
=&gt; (d/q '[:find [?e ...] :where [?e :user/name]] (d/db (d/connect datomic-uri)))
[17592186045422]
=&gt; (map #(d/touch (d/entity (d/db (d/connect datomic-uri)) %)) *1)
({:base/uuid #uuid "54d8fc2e-6c1f-4fb6-93f9-bef9536a9f7d", :user/age 31, :user/name "Bob", :db/id 17592186045422})
</code></pre>

<p>Now we have a user in the system, let's fill out his profile a bit:</p>

<pre><code>=&gt; (send-command :user/update-email {:uuid #uuid "54d8fc2e-6c1f-4fb6-93f9-bef9536a9f7d" :email "bob@example.com"})
=&gt; (send-command :user/disabled {:uuid #uuid "54d8fc2e-6c1f-4fb6-93f9-bef9536a9f7d"})
=&gt; (map #(d/touch (d/entity (d/db (d/connect datomic-uri)) %)) (d/q '[:find [?e ...] :where [?e :user/name]] (d/db (d/connect datomic-uri))))
({:base/uuid #uuid "54d90a89-0880-4f30-bb34-42f29ceb1095", :user/age 31, :user/email "bob@example.com", :user/name "Bob", :user/status :user.status/disabled, :db/id 17592186045422})
</code></pre>

<p>We can also send some pageviews and see how it updates the viewcount on the user (a possibly useful aggregate):</p>

<pre><code>=&gt; (send-command :user/pageview {:uuid #uuid "54d90a89-0880-4f30-bb34-42f29ceb1095" :url "http://www.example.com" :render-time 230})
=&gt; (send-command :user/pageview {:uuid #uuid "54d90a89-0880-4f30-bb34-42f29ceb1095" :url "http://www.example.com" :render-time 212})
=&gt; (send-command :user/pageview {:uuid #uuid "54d90a89-0880-4f30-bb34-42f29ceb1095" :url "http://www.example.com" :render-time 182})
=&gt; (map #(d/touch (d/entity (d/db (d/connect datomic-uri)) %)) (d/q '[:find [?e ...] :where [?e :user/name]] (d/db (d/connect datomic-uri))))
({:base/uuid #uuid "54d90a89-0880-4f30-bb34-42f29ceb1095", :user/age 31, :user/email "bob@example.com", :user/name "Bob", :user/status :user.status/disabled, :user/viewcount 3, :db/id 17592186045422})
</code></pre>

<p>Then lets have a look at the events:</p>

<pre><code>=&gt; (far/scan dynamodb-cred :events)
[{:date 1423510307575N, :data #&lt;byte[] ...&gt;, :basis-t 1008N, :id "86439637-8f1e-5170-9b23-824486e3506a", :type "user/pageviewed"} {:date 1423510178427N, :data #&lt;byte[] ...&gt;, :basis-t 1005N, :id "c67ccc74-c71c-5578-80ad-924c470f052f", :type "user/email-updated"} {:date 1423510316827N, :data #&lt;byte[] ...&gt;, :basis-t 1010N, :id "08316c9b-3fcd-5a9f-b095-4bf0c1a61a05", :type "user/pageviewed"} {:date 1423510210618N, :data #&lt;byte[] ...&gt;, :basis-t 1007N, :id "46ac00c9-bd7d-5903-91e0-af56d28ef751", :type "user/disabled"} {:date 1423510153513N, :data #&lt;byte[] ...&gt;, :basis-t 1000N, :id "be856c9c-0bf8-5ccc-bec1-bfa0f5a7e983", :type "user/registered"} {:date 1423510312463N, :data #&lt;byte[] ...&gt;, :basis-t 1009N, :id "5c2eb804-1016-5fa3-a868-c01b515f980d", :type "user/pageviewed"}]
</code></pre>

<p>The actual data is fressian encoded so that there's no pain with the transformation of clojure data structures.</p>

<p>NOTE: If you do actually use this for user aggregates and authentication, remember to at least bcrypt your passwords.
Be very aware that sensitive data is written to multiple places in this system: the kafka queues, the dynamo event source and the datomic aggregate. This is a particularly important consideration for things like credit card details and passwords.</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright Â© 2015 Yuppiechef Online (Pty) Ltd.</p>

<p>Distributed under The MIT License (MIT) - See LICENSE.txt</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Cqrs-server maintained by <a href="https://github.com/Yuppiechef">Yuppiechef</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-59536081-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
